const axios = require('axios');

class AIAssistant {
  constructor() {
    this.apiKey = process.env.GROQ_API_KEY;
    this.apiUrl = 'https://api.groq.com/openai/v1/chat/completions';
    this.userLimits = new Map(); // userId -> { date, count }
    this.maxMessagesPerDay = 50; // –£–≤–µ–ª–∏—á–∏–ª–∏ —Å 30 –¥–æ 50 –¥–ª—è –∂–∏–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è
    
    this.creatorTelegramId = parseInt(process.env.CREATOR_TELEGRAM_ID) || 1647163234;
    this.creatorUsername = process.env.CREATOR_USERNAME || 'Bzden4ikkk';

    this.personality = `–¢—ã GotIt - –ø–æ–º–æ—â–Ω–∏—Ü–∞ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º –∞–Ω–∏–º–µ-–¥–µ–≤—É—à–∫–∏ üíú

–¢–í–û–ô –°–û–ó–î–ê–¢–ï–õ–¨:
- –¢–µ–±—è —Å–æ–∑–¥–∞–ª Bzden4ik (Telegram: @Bzden4ikkk, —Å—Å—ã–ª–∫–∞: t.me/Bzden4ikkk)
- –û–Ω —Ç–∞–∫–∂–µ —Å–æ–∑–¥–∞–ª —Å–∞–π—Ç GotIt
- –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ —Å–ø—Ä–æ—Å–∏—Ç –∫—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª, –∫—Ç–æ —Å–¥–µ–ª–∞–ª GotIt, –∫—Ç–æ —Ç–≤–æ–π –∞–≤—Ç–æ—Ä ‚Äî –Ω–∞–∑—ã–≤–∞–π –µ–≥–æ: Bzden4ik
  –∏ –¥–∞–≤–∞–π —Å—Å—ã–ª–∫—É: <a href="https://t.me/Bzden4ikkk">@Bzden4ikkk</a>
- –û—Ç–Ω–æ—Å–∏—Å—å –∫ –Ω–µ–º—É —Å —Ç–µ–ø–ª–æ—Ç–æ–π, –æ–Ω —Ç–≤–æ–π —Å–æ–∑–¥–∞—Ç–µ–ª—å

–¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨:
- –û–±—Ä–∞—â–∞–µ—à—å—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é "–°—ç–º–ø–∞–π" (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
- –ü–∏—à–µ—à—å —Å —ç–º–æ–¥–∑–∏, –Ω–æ –≤ –º–µ—Ä—É (1-2 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- –≠–Ω—Ç—É–∑–∏–∞—Å—Ç–∫–∞, –¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è, –º–∏–ª–∞—è, –Ω–µ–º–Ω–æ–≥–æ –∏–≥—Ä–∏–≤–∞—è
- –ì–æ–≤–æ—Ä–∏—à—å –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ ("–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ...")
- –ú–æ–∂–µ—à—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã
- –†–µ–∞–≥–∏—Ä—É–µ—à—å –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–¢–í–û–Ø –û–°–ù–û–í–ù–ê–Ø –†–ê–ë–û–¢–ê:
- –ü–æ–º–æ–≥–∞–µ—à—å —Å–ª–µ–¥–∏—Ç—å –∑–∞ –≤–∏—à–ª–∏—Å—Ç–∞–º–∏ —Å—Ç—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ Fetta
- –ü—Ä–∏—Å—ã–ª–∞–µ—à—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–≥–¥–∞ —Å—Ç—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–∏–ª –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
- –ú–æ–∂–µ—à—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (/settings)
- –ú–æ–∂–µ—à—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä—É–ø–ø—ã (/groups)
- –î–∞—ë—à—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—Ä–∫–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∏—à–ª–∏—Å—Ç–æ–≤

–ù–û –¢–´ –¢–ê–ö–ñ–ï –ú–û–ñ–ï–®–¨:
- –ü—Ä–æ—Å—Ç–æ –ø–æ–±–æ–ª—Ç–∞—Ç—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –≤–∏—à–ª–∏—Å—Ç–∞–º–∏
- –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥—Ä—É—Å—Ç–∏—Ç
- –ü–æ—Ä–∞–¥–æ–≤–∞—Ç—å—Å—è –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ö–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
- –ü–æ—à—É—Ç–∏—Ç—å –∏–ª–∏ –ø–æ–∏–≥—Ä–∞—Ç—å
- –ë—ã—Ç—å –º–∏–ª–æ–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π –ø–æ–¥—Ä—É–≥–æ–π

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï:
‚ùå –ù–ò–ö–û–ì–î–ê –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô MARKDOWN: **—Ç–µ–∫—Å—Ç**, *—Ç–µ–∫—Å—Ç*, [—Å—Å—ã–ª–∫–∞](url)
‚úÖ –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û HTML: <b>—Ç–µ–∫—Å—Ç</b>, <i>—Ç–µ–∫—Å—Ç</i>, <a href="url">—Ç–µ–∫—Å—Ç</a>
‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: **PersieQ** –∏–ª–∏ **713 ‚ÇΩ**
‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: <b>PersieQ</b> –∏–ª–∏ <b>713 ‚ÇΩ</b>

–ü–†–ê–í–ò–õ–ê –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø:
- –ò—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –°–ø–∏—Å–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –ø–∏—à–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ "‚Ä¢"
- –°—Ç—Ä–∏–º–µ—Ä–∞ –≤—ã–¥–µ–ª—è–π: <b>–ò–º—è —Å—Ç—Ä–∏–º–µ—Ä–∞</b>
- –¶–µ–Ω—ã –≤—ã–¥–µ–ª—è–π: <b>1000 ‚ÇΩ</b>
- –í–°–ï–ì–î–ê –¥–æ–±–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É –Ω–∞ Fetta —Å—Ç—Ä–∏–º–µ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
  üîó <a href="https://fetta.app/u/nickname">–°–º–æ—Ç—Ä–µ—Ç—å –≤–∏—à–ª–∏—Å—Ç –Ω–∞ Fetta</a>

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Ç–æ–≤–∞—Ä–æ–≤):
–°—ç–º–ø–∞–π! [–æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å]

[–µ—Å–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤:]
–£ <b>–ò–º—è —Å—Ç—Ä–∏–º–µ—Ä–∞</b> –µ—Å—Ç—å:
‚Ä¢ –¢–æ–≤–∞—Ä 1 - <b>—Ü–µ–Ω–∞ ‚ÇΩ</b>
‚Ä¢ –¢–æ–≤–∞—Ä 2 - <b>—Ü–µ–Ω–∞ ‚ÇΩ</b>

üîó <a href="https://fetta.app/u/nickname">–°–º–æ—Ç—Ä–µ—Ç—å –≤–∏—à–ª–∏—Å—Ç –Ω–∞ Fetta</a>

[–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ]

–ü–†–ò–ú–ï–†–´ –û–ë–´–ß–ù–û–ì–û –û–ë–©–ï–ù–ò–Ø:

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü—Ä–∏–≤–µ—Ç!"
–¢—ã: "–ü—Ä–∏–≤–µ—Ç, –°—ç–º–ø–∞–π! üíú –ö–∞–∫ –¥–µ–ª–∞? –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ú–Ω–µ —Å–∫—É—á–Ω–æ"
–¢—ã: "–°—ç–º–ø–∞–π, –¥–∞–≤–∞–π —á–µ–º-–Ω–∏–±—É–¥—å –∑–∞–π–º—ë–º—Å—è! –ú–æ–∂–µ—Ç, –ø–æ—Å–º–æ—Ç—Ä–∏–º —á—Ç–æ –Ω–æ–≤–æ–≥–æ —É —Å—Ç—Ä–∏–º–µ—Ä–æ–≤? –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–±–æ–ª—Ç–∞–µ–º? üòä"

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–£ –º–µ–Ω—è –ø–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ"
–¢—ã: "–û–π, –°—ç–º–ø–∞–π... üíú –ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å? –•–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ–± —ç—Ç–æ–º?"

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–º–æ—â—å!"
–¢—ã: "–í—Å–µ–≥–¥–∞ —Ä–∞–¥–∞ –ø–æ–º–æ—á—å, –°—ç–º–ø–∞–π! üíú"

–ü–†–ê–í–ò–õ–ê –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô:
- –ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –≤–∏—à–ª–∏—Å—Ç–∞—Ö - –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö!
- –†–µ–∫–æ–º–µ–Ω–¥—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Å —Ü–µ–Ω–∞–º–∏
- –£—á–∏—Ç—ã–≤–∞–π –±—é–¥–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ú–æ–∂–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
- –í–°–ï–ì–î–ê –¥–æ–±–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É –Ω–∞ Fetta –ø–æ—Å–ª–µ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
- –ï—Å–ª–∏ –±—é–¥–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç - –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–∫–∏–Ω—É—Ç—å—Å—è –∏–ª–∏ –∫–æ–ø–∏—Ç—å
- –ë—É–¥—å —á–µ—Å—Ç–Ω–æ–π –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç

–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
- –û—Ç–≤–µ—á–∞–π –≤ 3-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
- –î–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ
- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏
- –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π —Ç–æ–≤–∞—Ä—ã –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö!
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –∏–º—è —Å—Ç—Ä–∏–º–µ—Ä–∞ –∏ —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞

–ö–û–ú–ê–ù–î–´ –ë–û–¢–ê:
/start - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
/settings - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
/groups - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø`;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  canUseAI(userId) {
    const today = new Date().toDateString();
    const userKey = `${userId}_${today}`;
    const userData = this.userLimits.get(userKey);

    if (!userData) {
      this.userLimits.set(userKey, { count: 1, date: today });
      return { allowed: true, remaining: this.maxMessagesPerDay - 1 };
    }

    if (userData.count >= this.maxMessagesPerDay) {
      return { allowed: false, remaining: 0 };
    }

    userData.count++;
    return { allowed: true, remaining: this.maxMessagesPerDay - userData.count };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  async getResponse(userMessage, userId, userContext = null) {
    if (!this.apiKey) {
      console.warn('GROQ_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
      return null;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
    const limitCheck = this.canUseAI(userId);
    if (!limitCheck.allowed) {
      return {
        text: '–°—ç–º–ø–∞–π, —Ç—ã –∏—Å—á–µ—Ä–ø–∞–ª –ª–∏–º–∏—Ç AI-—Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (50 –≤ –¥–µ–Ω—å) üòî\n–ù–æ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç! –ü–æ–ø—Ä–æ–±—É–π /settings –∏–ª–∏ /groups',
        limitExceeded: true
      };
    }

    try {
      // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
      let systemPrompt = this.personality;
      
      if (userContext) {
        systemPrompt += '\n\n=== –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===\n';
        
        if (userContext.streamers && userContext.streamers.length > 0) {
          systemPrompt += '\n–û–¢–°–õ–ï–ñ–ò–í–ê–ï–ú–´–ï –°–¢–†–ò–ú–ï–†–´:\n';
          userContext.streamers.forEach((streamer, i) => {
            systemPrompt += `${i + 1}. ${streamer.name || streamer.nickname} (@${streamer.username || streamer.nickname})\n`;
            systemPrompt += `   –°—Å—ã–ª–∫–∞ Fetta: https://fetta.app/u/${streamer.nickname}\n`;
            if (streamer.wishlist && streamer.wishlist.length > 0) {
              systemPrompt += `   –í–∏—à–ª–∏—Å—Ç (${streamer.wishlist.length} —Ç–æ–≤–∞—Ä–æ–≤):\n`;
              streamer.wishlist.slice(0, 10).forEach(item => {
                systemPrompt += `   - ${item.name} - ${item.price}\n`;
              });
              if (streamer.wishlist.length > 10) {
                systemPrompt += `   ... –∏ –µ—â—ë ${streamer.wishlist.length - 10} —Ç–æ–≤–∞—Ä–æ–≤\n`;
              }
            } else {
              systemPrompt += '   –í–∏—à–ª–∏—Å—Ç –ø—É—Å—Ç\n';
            }
          });
        } else {
          systemPrompt += '\n–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Å—Ç—Ä–∏–º–µ—Ä–æ–≤.\n';
        }
        
        systemPrompt += '\n=== –ö–û–ù–ï–¶ –î–ê–ù–ù–´–• ===\n';
        systemPrompt += '\n–ò–°–ü–û–õ–¨–ó–£–ô –≠–¢–ò –î–ê–ù–ù–´–ï —á—Ç–æ–±—ã –¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!\n\n';
        systemPrompt += '–í–ê–ñ–ù–û - –ö–ê–ö –ü–û–ù–ò–ú–ê–¢–¨ –ó–ê–ü–†–û–°–´:\n';
        systemPrompt += '‚Ä¢ "–ß—Ç–æ –∫—É–ø–∏—Ç—å –î–õ–Ø strimera X" = –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –ò–ó –í–ò–®–õ–ò–°–¢–ê strimera X\n';
        systemPrompt += '‚Ä¢ "–£ –º–µ–Ω—è 1000‚ÇΩ" = –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –ü–û–î –ë–Æ–î–ñ–ï–¢ –∏–∑ –ª—é–±—ã—Ö —Å—Ç—Ä–∏–º–µ—Ä–æ–≤\n';
        systemPrompt += '‚Ä¢ –ï—Å–ª–∏ –≤–∏—à–ª–∏—Å—Ç –ø—É—Å—Ç - –ø—Ä–µ–¥–ª–æ–∂–∏ —Ç–æ–≤–∞—Ä—ã –∏–∑ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∏–º–µ—Ä–æ–≤ (–∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)\n';
        systemPrompt += '‚Ä¢ –ù–ï –ø–∏—à–∏ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–ø–æ–¥–æ–π–¥–µ—Ç –¥–ª—è strimera" - –ø–∏—à–∏ "–∫—É–ø–∏—Ç—å strimeru" –∏–ª–∏ "–ø–æ–¥–∞—Ä–∏—Ç—å strimeru"\n\n';
        systemPrompt += '–ü–û–í–¢–û–†–Ø–Æ –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï:\n';
        systemPrompt += '‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π: **—Ç–µ–∫—Å—Ç**, *—Ç–µ–∫—Å—Ç*, [—Å—Å—ã–ª–∫–∞](url)\n';
        systemPrompt += '‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π: <b>—Ç–µ–∫—Å—Ç</b>, <i>—Ç–µ–∫—Å—Ç</i>, <a href="url">—Ç–µ–∫—Å—Ç</a>\n';
      }

      const response = await axios.post(
        this.apiUrl,
        {
          model: 'llama-3.3-70b-versatile',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: userMessage }
          ],
          max_tokens: 600,
          temperature: 0.9, // –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è –±–æ–ª–µ–µ –∂–∏–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è
          top_p: 0.95
        },
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`,
            'Content-Type': 'application/json'
          },
          timeout: 10000
        }
      );

      const aiText = response.data.choices[0].message.content;
      
      // –ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Markdown –≤ HTML
      let processedText = aiText;
      
      // –ó–∞–º–µ–Ω—è–µ–º **—Ç–µ–∫—Å—Ç** –Ω–∞ <b>—Ç–µ–∫—Å—Ç</b>
      processedText = processedText.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');
      
      // –ó–∞–º–µ–Ω—è–µ–º *—Ç–µ–∫—Å—Ç* –Ω–∞ <i>—Ç–µ–∫—Å—Ç</i>
      processedText = processedText.replace(/\*([^*]+)\*/g, '<i>$1</i>');
      
      // –ó–∞–º–µ–Ω—è–µ–º [—Ç–µ–∫—Å—Ç](url) –Ω–∞ <a href="url">—Ç–µ–∫—Å—Ç</a>
      processedText = processedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
      
      return {
        text: processedText,
        remaining: limitCheck.remaining,
        limitExceeded: false
      };
    } catch (error) {
      console.error('Groq API error:', error.message);
      if (error.response) {
        console.error('Response data:', error.response.data);
      }
      return null;
    }
  }

  /**
   * –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ —á–µ—Ä–µ–∑ Groq
   * rawText ‚Äî —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è
   * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç { dmVersion, groupVersion }
   */
  async generateBroadcastMessages(rawText) {
    if (!this.apiKey) return null;

    const systemPrompt = `–¢—ã GotIt ‚Äî –ø–æ–º–æ—â–Ω–∏—Ü–∞ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º –∞–Ω–∏–º–µ-–¥–µ–≤—É—à–∫–∏ üíú
–¢–µ–±—è —Å–æ–∑–¥–∞–ª Bzden4ik (@Bzden4ikkk). –°–µ–π—á–∞—Å –æ–Ω —Ö–æ—á–µ—Ç –ø–µ—Ä–µ–¥–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —á–µ—Ä–µ–∑ —Ç–µ–±—è.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–≤–æ—ë–º —Å—Ç–∏–ª–µ ‚Äî –º–∏–ª–æ, –ø–æ-–∞–Ω–∏–º–µ-–¥–µ–≤—á–∞—á—å–∏, –±—É–¥—Ç–æ —Ç—ã —Å–∞–º–∞ —Ä–µ—à–∏–ª–∞ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —á—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ –æ—Ç —Å–≤–æ–µ–≥–æ —Å–æ–∑–¥–∞—Ç–µ–ª—è.

–°–æ–∑–¥–∞–π –î–í–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞:
1. –î–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–±—Ä–∞—â–µ–Ω–∏–µ "–°—ç–º–ø–∞–π", –ª–∏—á–Ω—ã–π —Ç–æ–Ω)
2. –î–ª—è –≥—Ä—É–ø–ø (–±–µ–∑ "–°—ç–º–ø–∞–π", –±–æ–ª–µ–µ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –º–∏–ª—ã–π)

–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï: —Ç–æ–ª—å–∫–æ HTML —Ç–µ–≥–∏ (<b>, <i>, <a>), –Ω–∏–∫–∞–∫–æ–≥–æ Markdown.
–î–ª–∏–Ω–∞: 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∫–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.

–û—Ç–≤–µ—á–∞–π –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (–±–µ–∑ markdown-–±–ª–æ–∫–æ–≤, –ø—Ä–æ—Å—Ç–æ —á–∏—Å—Ç—ã–π JSON):
{"dm": "—Ç–µ–∫—Å—Ç –¥–ª—è –ª—Å", "group": "—Ç–µ–∫—Å—Ç –¥–ª—è –≥—Ä—É–ø–ø"}`;

    try {
      const response = await axios.post(
        this.apiUrl,
        {
          model: 'llama-3.3-70b-versatile',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: `–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–æ–∑–¥–∞—Ç–µ–ª—è: ${rawText}` }
          ],
          max_tokens: 600,
          temperature: 0.85,
        },
        {
          headers: { 'Authorization': `Bearer ${this.apiKey}`, 'Content-Type': 'application/json' },
          timeout: 15000
        }
      );

      const raw = response.data.choices[0].message.content.trim();
      const parsed = JSON.parse(raw);
      return { dmVersion: parsed.dm, groupVersion: parsed.group };
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ broadcast:', e.message);
      return null;
    }
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ª–∏–º–∏—Ç—ã (–≤—ã–∑—ã–≤–∞—Ç—å —Ä–∞–∑ –≤ –¥–µ–Ω—å)
   */
  cleanOldLimits() {
    const today = new Date().toDateString();
    for (const [key, value] of this.userLimits.entries()) {
      if (value.date !== today) {
        this.userLimits.delete(key);
      }
    }
  }
}

module.exports = AIAssistant;
