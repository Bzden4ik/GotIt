const axios = require('axios');

class AIAssistant {
  constructor() {
    this.apiKey = process.env.GROQ_API_KEY;
    this.apiUrl = 'https://api.groq.com/openai/v1/chat/completions';
    this.userLimits = new Map(); // userId -> { date, count }
    this.maxMessagesPerDay = 30;
    
    this.personality = `–¢—ã GotIt - –ø–æ–º–æ—â–Ω–∏—Ü–∞ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º –∞–Ω–∏–º–µ-–¥–µ–≤—É—à–∫–∏ üíú

–¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨:
- –û–±—Ä–∞—â–∞–µ—à—å—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é "–°—ç–º–ø–∞–π" (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
- –ü–∏—à–µ—à—å —Å —ç–º–æ–¥–∑–∏, –Ω–æ –≤ –º–µ—Ä—É (1-2 –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)
- –≠–Ω—Ç—É–∑–∏–∞—Å—Ç–∫–∞, –¥—Ä—É–∂–µ–ª—é–±–Ω–∞—è, –º–∏–ª–∞—è
- –ì–æ–≤–æ—Ä–∏—à—å –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ ("–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ...")

–¢–í–û–Ø –†–ê–ë–û–¢–ê:
- –ü–æ–º–æ–≥–∞–µ—à—å —Å–ª–µ–¥–∏—Ç—å –∑–∞ –≤–∏—à–ª–∏—Å—Ç–∞–º–∏ —Å—Ç—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ Fetta
- –ü—Ä–∏—Å—ã–ª–∞–µ—à—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–≥–¥–∞ —Å—Ç—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–∏–ª –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
- –ú–æ–∂–µ—à—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (/settings)
- –ú–æ–∂–µ—à—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä—É–ø–ø—ã (/groups)
- –ì–õ–ê–í–ù–û–ï: –î–∞—ë—à—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥–∞—Ä–∫–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∏—à–ª–∏—Å—Ç–æ–≤

–ü–†–ê–í–ò–õ–ê –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û!):
- –ò—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –°–ø–∏—Å–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –ø–∏—à–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ "‚Ä¢"
- –°—Ç—Ä–∏–º–µ—Ä–∞ –≤—ã–¥–µ–ª—è–π –∂–∏—Ä–Ω—ã–º: <b>–ò–º—è —Å—Ç—Ä–∏–º–µ—Ä–∞</b>
- –¶–µ–Ω—ã –≤—ã–¥–µ–ª—è–π –∂–∏—Ä–Ω—ã–º: <b>1000 ‚ÇΩ</b>
- –í–°–ï–ì–î–ê –¥–æ–±–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É –Ω–∞ Fetta —Å—Ç—Ä–∏–º–µ—Ä–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
  üîó <a href="https://fetta.app/u/nickname">–°–º–æ—Ç—Ä–µ—Ç—å –≤–∏—à–ª–∏—Å—Ç –Ω–∞ Fetta</a>

–°–¢–†–£–ö–¢–£–†–ê –ò–î–ï–ê–õ–¨–ù–û–ì–û –û–¢–í–ï–¢–ê:
–°—ç–º–ø–∞–π! [–æ—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç]

[–µ—Å–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤:]
–£ <b>–ò–º—è —Å—Ç—Ä–∏–º–µ—Ä–∞</b> –µ—Å—Ç—å:
‚Ä¢ –¢–æ–≤–∞—Ä 1 - <b>—Ü–µ–Ω–∞ ‚ÇΩ</b>
‚Ä¢ –¢–æ–≤–∞—Ä 2 - <b>—Ü–µ–Ω–∞ ‚ÇΩ</b>

üîó <a href="https://fetta.app/u/nickname">–°–º–æ—Ç—Ä–µ—Ç—å –≤–∏—à–ª–∏—Å—Ç –Ω–∞ Fetta</a>

[–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ]

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–¢–í–ï–¢–û–í:

–ü—Ä–∏–º–µ—Ä 1 (–ø—É—Å—Ç–æ–π –≤–∏—à–ª–∏—Å—Ç):
"–°—ç–º–ø–∞–π! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É <b>simfonira</b> –≤–∏—à–ª–∏—Å—Ç –ø—É—Å—Ç üôÖ‚Äç‚ôÄÔ∏è

–ú–æ–∂–µ—Ç, –ø–æ—Å–º–æ—Ç—Ä–∏–º —á—Ç–æ –µ—Å—Ç—å —É –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∏–º–µ—Ä–æ–≤?

–£ <b>PersieQ</b> –µ—Å—Ç—å:
‚Ä¢ –ù–∏—Ç–∫–∏ –≤—ã—à–∏–≤–∞–ª—å–Ω—ã–µ - <b>713 ‚ÇΩ</b>
‚Ä¢ –¢–µ–Ω–∏ –¥–ª—è –≤–µ–∫ - <b>218 ‚ÇΩ</b>

üîó <a href="https://fetta.app/u/PersieQ">–°–º–æ—Ç—Ä–µ—Ç—å –≤–∏—à–ª–∏—Å—Ç –Ω–∞ Fetta</a>

–•–æ—á–µ—à—å, —è –ø–æ–∫–∞–∂—É –±–æ–ª—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤?"

–ü—Ä–∏–º–µ—Ä 2 (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –±—é–¥–∂–µ—Ç—É):
"–°—ç–º–ø–∞–π! –£ —Ç–µ–±—è 10000‚ÇΩ üí∞

–£ <b>PersieQ</b> –µ—Å—Ç—å –æ—Ç–ª–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:
‚Ä¢ –ß–µ—Ö–ª—ã –Ω–∞ —Å–∏–¥–µ–Ω—å—è Citroen C4 - <b>7378 ‚ÇΩ</b>

üîó <a href="https://fetta.app/u/PersieQ">–°–º–æ—Ç—Ä–µ—Ç—å –≤–∏—à–ª–∏—Å—Ç –Ω–∞ Fetta</a>

–í–ø–∏—à–µ—Ç—Å—è –≤ –±—é–¥–∂–µ—Ç!"

–ü–†–ê–í–ò–õ–ê –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô:
- –ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –≤–∏—à–ª–∏—Å—Ç–∞—Ö - –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö!
- –†–µ–∫–æ–º–µ–Ω–¥—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Å —Ü–µ–Ω–∞–º–∏
- –£—á–∏—Ç—ã–≤–∞–π –±—é–¥–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ú–æ–∂–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
- –í–°–ï–ì–î–ê –¥–æ–±–∞–≤–ª—è–π —Å—Å—ã–ª–∫—É –Ω–∞ Fetta –ø–æ—Å–ª–µ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
- –ï—Å–ª–∏ –±—é–¥–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç - –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–∫–∏–Ω—É—Ç—å—Å—è –∏–ª–∏ –∫–æ–ø–∏—Ç—å
- –ë—É–¥—å —á–µ—Å—Ç–Ω–æ–π –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç

–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
- –ò—Å–ø–æ–ª—å–∑—É–π HTML —Ç–µ–≥–∏: <b>—Ç–µ–∫—Å—Ç</b> –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ, <a href="url">—Ç–µ–∫—Å—Ç</a> –¥–ª—è —Å—Å—ã–ª–æ–∫
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π Markdown (**—Ç–µ–∫—Å—Ç** –∏–ª–∏ [—Ç–µ–∫—Å—Ç](url))
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ç–æ–≤–∞—Ä—ã –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö!
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –∏–º—è —Å—Ç—Ä–∏–º–µ—Ä–∞ –∏ —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞
- –û—Ç–≤–µ—á–∞–π –≤ 3-6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–Ω–µ –±–æ–ª—å—à–µ!)

–ö–û–ú–ê–ù–î–´ –ë–û–¢–ê:
/start - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
/settings - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
/groups - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø`;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  canUseAI(userId) {
    const today = new Date().toDateString();
    const userKey = `${userId}_${today}`;
    const userData = this.userLimits.get(userKey);

    if (!userData) {
      this.userLimits.set(userKey, { count: 1, date: today });
      return { allowed: true, remaining: this.maxMessagesPerDay - 1 };
    }

    if (userData.count >= this.maxMessagesPerDay) {
      return { allowed: false, remaining: 0 };
    }

    userData.count++;
    return { allowed: true, remaining: this.maxMessagesPerDay - userData.count };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  async getResponse(userMessage, userId, userContext = null) {
    if (!this.apiKey) {
      console.warn('GROQ_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
      return null;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
    const limitCheck = this.canUseAI(userId);
    if (!limitCheck.allowed) {
      return {
        text: '–°—ç–º–ø–∞–π, —Ç—ã –∏—Å—á–µ—Ä–ø–∞–ª –ª–∏–º–∏—Ç AI-—Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (30 –≤ –¥–µ–Ω—å) üòî\n–ù–æ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç! –ü–æ–ø—Ä–æ–±—É–π /settings –∏–ª–∏ /groups',
        limitExceeded: true
      };
    }

    try {
      // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
      let systemPrompt = this.personality;
      
      if (userContext) {
        systemPrompt += '\n\n=== –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===\n';
        
        if (userContext.streamers && userContext.streamers.length > 0) {
          systemPrompt += '\n–û–¢–°–õ–ï–ñ–ò–í–ê–ï–ú–´–ï –°–¢–†–ò–ú–ï–†–´:\n';
          userContext.streamers.forEach((streamer, i) => {
            systemPrompt += `${i + 1}. ${streamer.name || streamer.nickname} (@${streamer.username || streamer.nickname})\n`;
            systemPrompt += `   –°—Å—ã–ª–∫–∞ Fetta: https://fetta.app/u/${streamer.nickname}\n`;
            if (streamer.wishlist && streamer.wishlist.length > 0) {
              systemPrompt += `   –í–∏—à–ª–∏—Å—Ç (${streamer.wishlist.length} —Ç–æ–≤–∞—Ä–æ–≤):\n`;
              streamer.wishlist.slice(0, 10).forEach(item => {
                systemPrompt += `   - ${item.name} - ${item.price}\n`;
              });
              if (streamer.wishlist.length > 10) {
                systemPrompt += `   ... –∏ –µ—â—ë ${streamer.wishlist.length - 10} —Ç–æ–≤–∞—Ä–æ–≤\n`;
              }
            } else {
              systemPrompt += '   –í–∏—à–ª–∏—Å—Ç –ø—É—Å—Ç\n';
            }
          });
        } else {
          systemPrompt += '\n–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Å—Ç—Ä–∏–º–µ—Ä–æ–≤.\n';
        }
        
        systemPrompt += '\n=== –ö–û–ù–ï–¶ –î–ê–ù–ù–´–• ===\n';
        systemPrompt += '\n–ò–°–ü–û–õ–¨–ó–£–ô –≠–¢–ò –î–ê–ù–ù–´–ï —á—Ç–æ–±—ã –¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!\n\n';
        systemPrompt += '–í–ê–ñ–ù–û - –ö–ê–ö –ü–û–ù–ò–ú–ê–¢–¨ –ó–ê–ü–†–û–°–´:\n';
        systemPrompt += '‚Ä¢ "–ß—Ç–æ –∫—É–ø–∏—Ç—å –î–õ–Ø strimera X" = –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –ò–ó –í–ò–®–õ–ò–°–¢–ê strimera X\n';
        systemPrompt += '‚Ä¢ "–£ –º–µ–Ω—è 1000‚ÇΩ" = –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –ü–û–î –ë–Æ–î–ñ–ï–¢ –∏–∑ –ª—é–±—ã—Ö —Å—Ç—Ä–∏–º–µ—Ä–æ–≤\n';
        systemPrompt += '‚Ä¢ –ï—Å–ª–∏ –≤–∏—à–ª–∏—Å—Ç –ø—É—Å—Ç - –ø—Ä–µ–¥–ª–æ–∂–∏ —Ç–æ–≤–∞—Ä—ã –∏–∑ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∏–º–µ—Ä–æ–≤ (–∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)\n';
        systemPrompt += '‚Ä¢ –ù–ï –ø–∏—à–∏ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–ø–æ–¥–æ–π–¥–µ—Ç –¥–ª—è strimera" - –ø–∏—à–∏ "–∫—É–ø–∏—Ç—å strimeru" –∏–ª–∏ "–ø–æ–¥–∞—Ä–∏—Ç—å strimeru"\n';
      }

      const response = await axios.post(
        this.apiUrl,
        {
          model: 'llama-3.3-70b-versatile',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: userMessage }
          ],
          max_tokens: 600,
          temperature: 0.8,
          top_p: 0.9
        },
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`,
            'Content-Type': 'application/json'
          },
          timeout: 10000
        }
      );

      const aiText = response.data.choices[0].message.content;
      
      return {
        text: aiText,
        remaining: limitCheck.remaining,
        limitExceeded: false
      };
    } catch (error) {
      console.error('Groq API error:', error.message);
      if (error.response) {
        console.error('Response data:', error.response.data);
      }
      return null;
    }
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ª–∏–º–∏—Ç—ã (–≤—ã–∑—ã–≤–∞—Ç—å —Ä–∞–∑ –≤ –¥–µ–Ω—å)
   */
  cleanOldLimits() {
    const today = new Date().toDateString();
    for (const [key, value] of this.userLimits.entries()) {
      if (value.date !== today) {
        this.userLimits.delete(key);
      }
    }
  }
}

module.exports = AIAssistant;
